<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> React Native 开发经验 · 我只是一只小前端</title><meta name="description" content="React Native 开发经验 - Selva"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><script type="text/javascript" src="js/bdtj.js"></script><link rel="search" type="application/opensearchdescription+xml" href="https://li1xu1bin.github.io/atom.xml" title="我只是一只小前端"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">主页</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="https://li1xu1bin.github.io/little-note/" target="_blank" class="nav-list-link">小笔记</a></li><li class="nav-list-item"><a href="https://github.com/li1xu1bin" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="http://i.ui.cn/ucenter/927889.html" target="_blank" class="nav-list-link">UI中国</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">React Native 开发经验</h1><div class="post-info">2019年1月30日</div><div class="post-content"><p><a href="https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=8_5" target="_blank" rel="noopener">React-Native项目在Android真机上调试</a>  </p>
<h2 id="页面路由-解决方案"><a href="#页面路由-解决方案" class="headerlink" title="页面路由 解决方案"></a>页面路由 解决方案</h2><p>路由插件：<a href="https://reactnavigation.org/docs/zh-Hans/hello-react-navigation.html" target="_blank" rel="noopener">React Navigation</a>  </p>
<h2 id="微信支付-解决方案"><a href="#微信支付-解决方案" class="headerlink" title="微信支付 解决方案"></a>微信支付 解决方案</h2><p>微信插件：<a href="https://github.com/yorkie/react-native-wechat" target="_blank" rel="noopener">react-native-wechat</a>  </p>
<p>参考文档<br><a href="https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=8_5" target="_blank" rel="noopener">APP端开发步骤</a><br><a href="https://www.jianshu.com/p/3f424cccb888" target="_blank" rel="noopener">react-native-wechat微信组件的使用</a><br><a href="https://www.jianshu.com/p/6a792118fae4" target="_blank" rel="noopener">react-native-wechat （react-native 微信分享、支付)</a>  </p>
<h2 id="图片上传-解决方案"><a href="#图片上传-解决方案" class="headerlink" title="图片上传 解决方案"></a>图片上传 解决方案</h2><p>图片插件：<a href="https://github.com/ivpusic/react-native-image-crop-picker" target="_blank" rel="noopener">react-native-image-crop-picker</a>  支持从相机和图库选择图片，裁剪图片，返回base64格式  </p>
<p>参考文档<br><a href="https://www.jianshu.com/p/71dee6198b56" target="_blank" rel="noopener">react-native-image-crop-picker 配置教程</a></p>
<h2 id="WebView-解决方案"><a href="#WebView-解决方案" class="headerlink" title="WebView 解决方案"></a>WebView 解决方案</h2><p>react native 原生库移除了webview组件，故用第三方库<a href="https://github.com/react-native-community/react-native-webview" target="_blank" rel="noopener">react-native-webview</a>，API跟官方文档的一模一样</p>
<h3 id="1-高度自适应"><a href="#1-高度自适应" class="headerlink" title="1. 高度自适应"></a>1. 高度自适应</h3><p>商品详情页要展示后台返回的一段html，需要给定webview一个高度，但是又不能写成固定高度，所以需要获取内容的高度，达到自适应。</p>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><p>使用<code>injectedJavaScript</code>注入一段js代码获取网页内容高度，然后调用<code>window.postMessage</code>方法把高度回调给<code>onMessage</code>方法，然后<code>setState</code>，改变webview高度，从而实现自适应。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">//injectedJavaScript 注入的代码</span><br><span class="line">const BaseScript =</span><br><span class="line">    `</span><br><span class="line">    (function () &#123;</span><br><span class="line">        var height = null;</span><br><span class="line">        function changeHeight() &#123;</span><br><span class="line">          if (document.body.scrollHeight != height) &#123;</span><br><span class="line">            height = document.body.scrollHeight;</span><br><span class="line">            if (window.postMessage) &#123;</span><br><span class="line">              window.postMessage(JSON.stringify(&#123;</span><br><span class="line">                type: &apos;setHeight&apos;,</span><br><span class="line">                height: height,</span><br><span class="line">              &#125;))</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        setTimeout(changeHeight, 300);</span><br><span class="line">    &#125; ())</span><br><span class="line">    `</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// web端发送过来的交互消息</span><br><span class="line">   onMessage(event) &#123;</span><br><span class="line">       try &#123;</span><br><span class="line">           const action = JSON.parse(event.nativeEvent.data)</span><br><span class="line">           if (action.type === &apos;setHeight&apos; &amp;&amp; action.height &gt; 0) &#123;</span><br><span class="line">               this.setState(&#123; height: action.height &#125;)</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; catch (error) &#123;</span><br><span class="line">           // pass</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// webview 配置</span><br><span class="line">   &lt;WebView</span><br><span class="line">       injectedJavaScript=&#123;BaseScript&#125;</span><br><span class="line">       style=&#123;&#123;</span><br><span class="line">           width: Dimensions.get(&apos;window&apos;).width,</span><br><span class="line">           height: this.state.height</span><br><span class="line">       &#125;&#125;</span><br><span class="line">       automaticallyAdjustContentInsets</span><br><span class="line">       source=&#123;&#123; html: html &#125;&#125;// 后台返回的html</span><br><span class="line">       decelerationRate=&apos;normal&apos;</span><br><span class="line">       javaScriptEnabled //仅限Android平台。iOS平台JavaScript是默认开启的。</span><br><span class="line">       domStorageEnabled // 适用于安卓，开启DOM本地存储</span><br><span class="line">       scrollEnabled=&#123;false&#125; //不启动滑动</span><br><span class="line">       onMessage=&#123;this.onMessage.bind(this)&#125;</span><br><span class="line">   /&gt;</span><br></pre></td></tr></table></figure>
<h3 id="2-iOS缩放问题"><a href="#2-iOS缩放问题" class="headerlink" title="2. iOS缩放问题"></a>2. iOS缩放问题</h3><p>ios的webview有两种：UIWebView和WKWebView，旧的UIWebView可以通过设置<code>scalesPageToFit</code>来自动适配视图，但是真机体验中有内存泄露问题，造成闪退，抛弃之。新的WKWebView不会自动适配，故要自己设置。</p>
<h4 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h4><p>把后台返回的html代码组装成设置了宽度自适应的完整html即可<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const html = &apos;&lt;!DOCTYPE html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt;&apos;</span><br><span class="line">        + &apos;&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width,height=device-height,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no&quot;&gt;&apos;</span><br><span class="line">        + &apos;&lt;title&gt;test&lt;/title&gt;&lt;/head&gt;&apos;</span><br><span class="line">        + &apos;&lt;body&gt;&apos;</span><br><span class="line">        + this.state.html //后台返回的html</span><br><span class="line">        + &apos;&lt;/body&gt;&lt;/html&gt;&apos;</span><br></pre></td></tr></table></figure></p>
<h2 id="热更新-解决方案"><a href="#热更新-解决方案" class="headerlink" title="热更新 解决方案"></a>热更新 解决方案</h2><p>热更新插件：<a href="https://github.com/reactnativecn/react-native-pushy" target="_blank" rel="noopener">react-native-pushy</a>  </p>
<table>
<thead>
<tr>
<th>重要API</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>isFirstTime</td>
<td>是否更新后的首次启动</td>
</tr>
<tr>
<td>markSuccess</td>
<td>确保更新成功</td>
</tr>
<tr>
<td>checkUpdate</td>
<td>检查更新</td>
</tr>
<tr>
<td>downloadUpdate</td>
<td>下载更新版本</td>
</tr>
<tr>
<td>switchVersion</td>
<td>立即重启应用</td>
</tr>
</tbody>
</table>
<h3 id="1-热更新之后图片丢失"><a href="#1-热更新之后图片丢失" class="headerlink" title="1.热更新之后图片丢失"></a>1.热更新之后图片丢失</h3><h4 id="解决方案：把图片重新压缩一次-TinyPNG"><a href="#解决方案：把图片重新压缩一次-TinyPNG" class="headerlink" title="解决方案：把图片重新压缩一次  TinyPNG"></a>解决方案：把图片重新压缩一次  <a href="https://tinypng.com/" target="_blank" rel="noopener">TinyPNG</a></h4><p>参考文档<br><a href="https://github.com/reactnativecn/react-native-pushy/blob/master/docs/guide.md" target="_blank" rel="noopener">react-native-pushy教程</a></p>
<h2 id="一些报错的解决方法"><a href="#一些报错的解决方法" class="headerlink" title="一些报错的解决方法"></a>一些报错的解决方法</h2><h3 id="1-连接不上真机"><a href="#1-连接不上真机" class="headerlink" title="1.连接不上真机"></a>1.连接不上真机</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Execution failed for task &apos;:app:installDebug&apos;  </span><br><span class="line">Failed to install on any devices.</span><br></pre></td></tr></table></figure>
<p>解决方法：下载一个ADB工具包，运行<code>adb devices</code>命令即可。</p>
<h3 id="2-安卓依赖出错"><a href="#2-安卓依赖出错" class="headerlink" title="2.安卓依赖出错"></a>2.安卓依赖出错</h3><p>在开发过程中会尝试很多插件，有时候删除不干净或冲突之后，项目经常会跑不起来，有各种各样的报错。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Execution failed for task &apos;:app:processDebugResources&apos;</span><br></pre></td></tr></table></figure></p>
<p>解决方法：在android目录下运行<code>gradlew clean</code>命令，清理已构建的项目以及依赖，再重新运行项目即可。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/04/14/Vue/" class="next">下一篇</a></div><div class="copyright"><p>© 2016 - 2019 <a href="https://li1xu1bin.github.io">Selva</a></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":100,"height":100,"hOffset":0,"vOffset":-20},"mobile":{"show":false},"react":{"opacityDefault":1}});</script></body></html>